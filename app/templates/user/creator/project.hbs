<nav class="project-header-height flex justify-between items-center ph3">
  <div class="flex justify-between w-100 items-center">    
    <h1 class="ma0 f3">{{this.model.displayTitle}}</h1>
      <div class="flex">
        <IconButton class="mh1" @icon="fi-play" @label="play" {{action "play"}} />
        <IconButton class="mh1" @icon="fi-stop" @label="stop" {{action "stop"}} />
        <IconButton class="mh1" @icon="fi-previous" @label="reset" {{action "reset"}} />
        <div class="flex items-center ba b--dark-gray bw1 ml2">
          <NexusNumber
            @value={{this.model.bpm}} 
            @onChangeNumber={{fn this.updateProject "bpm"}}
            @min={{0}}
            @max={{500}}
            @step={{1}}
          />
          <span class="pr3">bpm</span>
        </div>
      </div>
    <div class="flex ml3">
      <ButtonPrimary @label={{"Add New Track"}} {{on "click" this.addTrack}}/>
      <DropdownMenu 
        class="h-100 grow-1 bg-dark-gray ba bl-0 bw1 b--yellow"
        @icon={{"fi-play"}}
        @iconClass={{"yellow-fill rotate-90"}}
        @items={{array 
          (hash label="Sampler" select=(fn this.addTrack "samplerPreset")) 
          (hash label="Synth" select=(fn this.addTrack "synthPreset")) 
          (hash label="New From Preset")
          (hash label="Drum Machine")
          (hash label="Blank Track" select=(fn this.addTrack "signalChainGui")) 
        }}
      />
    </div>
  </div>
</nav>

<div class="flex project-tracks-height overflow-hidden">
  {{#if (and this.leftSidebarOpen this.activeTrack (not this.activeTrack.isDeleted))}}
    <SidebarWrapper 
      class="left-sidebar-width h-100 bw2 br b--yellow"
      @direction="left"
      @onCloseSidebar={{fn this.toggleSidebar this.activeTrack.id "left"}}
    >
      <div class="mh3 yellow relative flex flex-column">
        <h3 class="mv3">Drum Machines</h3>
        <InfoBox class="absolute right-2 top-0">
          <p class="f6 mb3 mt0">When you select a sound file from this menu the sound's URL is available in the code as <code>this.filepath</code>.
          </p>
          <p class="f6 mb3 mt0">You pass the sound's URL to a <code>sampler</code> node in the setup script like so:</p>
          <p class="f6 mb3 mt0"><code>__().sampler(path: this.filepath)</code></p>
        </InfoBox>
      </div>
      <DrumFilePicker
        @track={{this.activeTrack}}
      />
    </SidebarWrapper>
  {{/if}}
  <TrackListWrapper
    @rightSidebarOpen={{this.rightSidebarOpen}} 
    @leftSidebarOpen={{this.leftSidebarOpen}}
  >
    <div class="overflow-scroll">
      {{#each this.sortedTracks key="order" as |track|}}
        {{#unless track.isMaster}}
          <TrackListItem
            @track={{track}}
            @isActive={{eq track.id this.activeTrack.id}} 
            @selectActiveTrack={{fn this.transitionToTrack track.id}}
            @onToggleFilePicker={{fn this.toggleSidebar track.id "left"}}
            @onToggleScripts={{fn this.toggleSidebar track.id "right"}}
            @rightSidebarOpen={{this.rightSidebarOpen}} 
          />
        {{/unless}}
      {{/each}}
      {{#each this.sortedTracks as |track|}}
        {{#if track.isMaster}}
          <TrackListItem
            @track={{track}}
            @isActive={{eq track.id this.activeTrack.id}} 
            @selectActiveTrack={{fn this.transitionToTrack track.id}}
            @onToggleScripts={{fn this.toggleSidebar track.id "right"}}
            @rightSidebarOpen={{this.rightSidebarOpen}} 
          />
        {{/if}}
      {{/each}}
    </div>
    {{outlet}}
  </TrackListWrapper>
  {{#if (and this.rightSidebarOpen this.activeTrack (not this.activeTrack.isDeleted))}}
    <SidebarWrapper class="right-sidebar-width h-100 bw2 bl b--yellow"
      @direction="right"
      @onCloseSidebar={{fn this.toggleSidebar this.activeTrack.id "right"}}
    >
      <div class="mh3 yellow relative flex flex-column">
        <h3 class="mv3">Edit Track {{this.activeTrack.order}} Scripts</h3>
        <InfoBox class="absolute right-2 top-0">
          <p class="f6 mb3 mt0">Scripts are where you define the audio signal chain for each track.</p>
          <p class="f6 mb3 mt0"><b>Setup Script</b> runs once to create your audio signal chain. Audio Nodes can be defined with a <code>class</code> or <code>ID</code>, which are used to select and modify their parameters.</p>
          <p class="f6 mb3 mt0"><b>Play Script</b> runs on every step of the sequencer. This is where you trigger sound and modulate parameters.<br> Select node IDs with: <code>__('#someID')</code> <br>Select node classes with: <code>__('.someClass')</code> </p>
          <p class="mv0"><a class="blue fw6 ttu" href="https://billorcutt.github.io/i_dropped_my_phone_the_screen_cracked/cracked.html" target="_blank" rel="noopener noreferrer">Read the Cracked docs</a></p>
        </InfoBox>
      </div>
      <ScriptWrapper
        @track={{this.activeTrack}}
        @presetCollections={{this.presetCollections}}
      />
    </SidebarWrapper>
  {{/if}}
</div>